"use strict";(self.webpackChunk_1j1s_etl_docs=self.webpackChunk_1j1s_etl_docs||[]).push([[78],{479:(e,n,o)=>{o.r(n),o.d(n,{assets:()=>c,contentTitle:()=>r,default:()=>u,frontMatter:()=>t,metadata:()=>s,toc:()=>a});const s=JSON.parse('{"id":"tuto/copie-donnee-en-local","title":"Lorsque l\'indexation depuis Strapi \xe9choue : copier les donn\xe9es en local","description":"23 Juillet 2024","source":"@site/docs/tuto/copie-donnee-en-local.md","sourceDirName":"tuto","slug":"/tuto/copie-donnee-en-local","permalink":"/1j1s-etl/docs/tuto/copie-donnee-en-local","draft":false,"unlisted":false,"editUrl":"https://github.com/DNUM-SocialGouv/1j1s-etl/tree/main/docs/docs/docs/tuto/copie-donnee-en-local.md","tags":[],"version":"current","sidebarPosition":7,"frontMatter":{"sidebar_label":"Que faire si l\'indexation des donn\xe9es reste bloqu\xe9e \xe0 10000 donn\xe9es ?","sidebar_position":7},"sidebar":"tutorialSidebar","previous":{"title":"Les Scheduled tasks, comment \xe7a marche ?","permalink":"/1j1s-etl/docs/tuto/scheduled-tasks"},"next":{"title":"Comment mettre en Production ?","permalink":"/1j1s-etl/docs/tuto/tutoMeP"}}');var i=o(4848),l=o(8453);const t={sidebar_label:"Que faire si l'indexation des donn\xe9es reste bloqu\xe9e \xe0 10000 donn\xe9es ?",sidebar_position:7},r="Lorsque l'indexation depuis Strapi \xe9choue : copier les donn\xe9es en local",c={},a=[{value:"Explication de la proc\xe9dure",id:"explication-de-la-proc\xe9dure",level:3},{value:"Copie des donn\xe9es de recette en local",id:"copie-des-donn\xe9es-de-recette-en-local",level:2},{value:"Pr\xe9requis",id:"pr\xe9requis",level:3},{value:"Variables d&#39;environnement utiles",id:"variables-denvironnement-utiles",level:3},{value:"Connexion",id:"connexion",level:3},{value:"T\xe9l\xe9chargement de la Backup",id:"t\xe9l\xe9chargement-de-la-backup",level:3},{value:"Monter la backup dans le conteneur local",id:"monter-la-backup-dans-le-conteneur-local",level:3}];function d(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",p:"p",pre:"pre",...(0,l.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"lorsque-lindexation-depuis-strapi-\xe9choue--copier-les-donn\xe9es-en-local",children:"Lorsque l'indexation depuis Strapi \xe9choue : copier les donn\xe9es en local"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.em,{children:"23 Juillet 2024"})}),"\n",(0,i.jsx)(n.admonition,{title:"Contexte",type:"info",children:(0,i.jsx)(n.p,{children:"Si vous avez suivi la proc\xe9dure de resynchronisation et qu'\xe0 l'appui sur \"update\" la valeur du nombre de donn\xe9es index\xe9e reste bloqu\xe9e \xe0 10000 : L'anomalie provient du plugin Meilisearch utilis\xe9 qui limite \xe0 10000 indexations.\nLorsque l\u2019ETL effectue son travail d\u2019upsert des contenus \xe0 charger sur Strapi, celui-ci impacte le nombre d'\xe9l\xe9ments d\u2019une collection (offre de stage, annonces de logements\u2026) et modifie nombre d\u2019entre eux. Puis, le plugin Meilisearch, au travers d\u2019une r\xe9action \xe0 un \xe9v\xe8nement propag\xe9 par Strapi, envoie un document \xe0 indexer dans Meilisearch."})}),"\n",(0,i.jsx)(n.h3,{id:"explication-de-la-proc\xe9dure",children:"Explication de la proc\xe9dure"}),"\n",(0,i.jsx)(n.p,{children:"Une d\xe9synchronisation entre le contenu index\xe9 par Meilisearch et le contenu pr\xe9sent en base de donn\xe9es est donc quotidiennement pr\xe9sente.\nPour r\xe9soudre le probl\xe8me nous avons mis en place une solution de contournement en lan\xe7ant l'indexation depuis un strapi local, connect\xe9 \xe0 la base de recette."}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"copie-des-donn\xe9es-de-recette-en-local",children:"Copie des donn\xe9es de recette en local"}),"\n",(0,i.jsxs)(n.p,{children:["Le script ",(0,i.jsx)(n.code,{children:"populate-with-recette-data.sh"})," \xe0 la racine a \xe9t\xe9 mis en place pour la copie des donn\xe9es du CMS de recette vers le CMS conteneuris\xe9.\nCi-dessous l'explication du fonctionnement de ce script."]}),"\n",(0,i.jsx)(n.h3,{id:"pr\xe9requis",children:"Pr\xe9requis"}),"\n",(0,i.jsx)(n.p,{children:"Afin de pouvoir ex\xe9cuter le script, il faut avoir copi\xe9 le contenu de `.env.docker' dans '.env'."}),"\n",(0,i.jsx)(n.p,{children:"Ensuite, vous devez avoir en votre possession une clef vous permettant de vous connecter sur l'environnement depuis lequel l'on veut copier.\nPour la g\xe9n\xe9rer : il suffit de se connecter sur son compte Scalingo et g\xe9n\xe9rer un API Token."}),"\n",(0,i.jsxs)(n.p,{children:["Cette clef (API Token) est \xe0 remplir dans la variable d'environnement ",(0,i.jsx)(n.code,{children:"SCALINGO_API_TOKEN"})," dans ",(0,i.jsx)(n.code,{children:".env"}),"."]}),"\n",(0,i.jsxs)(n.p,{children:["Pour manipuler les conteneurs et applications sur Scalingo, il vous faudra ",(0,i.jsx)(n.a,{href:"https://doc.scalingo.com/platform/cli/start#install-scalingo-cli",children:"installer leur CLI"})]}),"\n",(0,i.jsxs)(n.p,{children:["Vous pouvez ex\xe9cuter la commande suivante pour installer ou mettre \xe0 jour ",(0,i.jsx)(n.code,{children:"Scalingo CLI"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-/bin/bash",children:"$ curl -O https://cli-dl.scalingo.com/install && bash install\n"})}),"\n",(0,i.jsx)(n.h3,{id:"variables-denvironnement-utiles",children:"Variables d'environnement utiles"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-/bin/bash",children:"# populate-with-recette-data.sh\n\nexport SCALINGO_APP='1j1s-main-cms'\nexport SCALINGO_REGION='osc-fr1'\nexport ADDON_NAME='postgresql'\nexport SCALINGO_DB_USER='<l'utilisateur db prod>'\n"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-/bin/bash",children:"# .env\n\nSCALINGO_API_TOKEN='<la clef API de Scalingo>'\n"})}),"\n",(0,i.jsx)(n.h3,{id:"connexion",children:"Connexion"}),"\n",(0,i.jsxs)(n.p,{children:["Dans un premier temps, il faut se connecter avec la clef r\xe9cup\xe9r\xe9e ci-dessus.\nUne v\xe9rification est faite en amont pour arr\xeater le script s'il n'y a pas de ",(0,i.jsx)(n.code,{children:".env"})," local."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-/bin/bash",children:"if [ -f .env ]\nthen\n  export $(cat .env | xargs)\nelse\n  exit 1\nfi\n\nscalingo login --api-token ${API_TOKEN}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"t\xe9l\xe9chargement-de-la-backup",children:"T\xe9l\xe9chargement de la Backup"}),"\n",(0,i.jsx)(n.p,{children:"Pour t\xe9l\xe9charger la derni\xe8re backup de la BDD en recette, on lance les commandes suivantes :"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-/bin/bash",children:"addon_id=$(scalingo addons | grep $ADDON_NAME | cut -d'|' -f3 | tr -d ' ')\nmkdir -p tmp && cd tmp\nscalingo --addon ${addon_id} backups-download --output ./backup\ntar -xvf ./backup\nfor filename in *.pgsql; do eval mv \\\"$filename\\\" \\\"backup.pgsql\\\"; done\ncd ..\n"})}),"\n",(0,i.jsxs)(n.p,{children:["A ce stade, nous avons un fichier ",(0,i.jsx)(n.code,{children:"backup.psql"})," dans le dossier ",(0,i.jsx)(n.code,{children:"tmp"})," qui contient la BDD de recette."]}),"\n",(0,i.jsx)(n.h3,{id:"monter-la-backup-dans-le-conteneur-local",children:"Monter la backup dans le conteneur local"}),"\n",(0,i.jsx)(n.p,{children:"Une fois le t\xe9l\xe9chargement termin\xe9, il suffit de lancer le docker de BDD en lui chargeant le fichier."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-/bin/bash",children:'docker compose down -v\ndocker compose --env-file .env.docker up -d db\nsleep 5\ndocker compose exec db psql "${DATABASE_URL}" -c "CREATE USER ${SCALINGO_DB_USER} SUPERUSER;"\ndocker compose cp ./tmp/backup.pgsql db:/tmp/backup.pgsql\ndocker compose exec db pg_restore -d ${DATABASE_URL} /tmp/backup.pgsql\n'})})]})}function u(e={}){const{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},8453:(e,n,o)=>{o.d(n,{R:()=>t,x:()=>r});var s=o(6540);const i={},l=s.createContext(i);function t(e){const n=s.useContext(l);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:t(e.components),s.createElement(l.Provider,{value:n},e.children)}}}]);